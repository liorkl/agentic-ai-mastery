name: Lint & Limits

on:
  push:
    branches:
      - master
      - "feat/**"
      - "fix/**"
  pull_request:
    branches:
      - master

jobs:
  lint:
    name: Lint files and enforce size limits
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "Validating .claude-plugin/plugin.json..."
          python3 -m json.tool .claude-plugin/plugin.json > /dev/null

          echo "Validating .claude-plugin/marketplace.json..."
          python3 -m json.tool .claude-plugin/marketplace.json > /dev/null

          echo "Validating .claude/settings.json..."
          python3 -m json.tool .claude/settings.json > /dev/null

          echo "All JSON files are valid."

      - name: Check plugin.json only contains known keys
        run: |
          python3 - <<'EOF'
          import json, sys

          # Keys supported by the Claude Code plugin schema.
          # "permissions" is NOT supported â€” it causes install to fail.
          # Update this list when the schema is officially extended.
          ALLOWED_KEYS = {"name", "version", "description", "author", "license", "keywords", "homepage", "repository"}
          ALLOWED_AUTHOR_KEYS = {"name", "email", "url"}

          data = json.load(open(".claude-plugin/plugin.json"))

          unknown = set(data.keys()) - ALLOWED_KEYS
          if unknown:
              print(f"FAIL: plugin.json contains unrecognized keys: {unknown}")
              print("These will cause 'claude plugin install' to fail with a validation error.")
              sys.exit(1)

          author = data.get("author", {})
          if isinstance(author, dict):
              unknown_author = set(author.keys()) - ALLOWED_AUTHOR_KEYS
              if unknown_author:
                  print(f"FAIL: plugin.json author contains unrecognized keys: {unknown_author}")
                  sys.exit(1)

          print("OK: plugin.json keys are valid.")
          EOF

      - name: Check knowledge file line limits (per-file max 500)
        run: |
          failed=0
          while IFS= read -r f; do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 500 ]; then
              echo "FAIL: $f has $lines lines (max 500)"
              failed=1
            else
              echo "OK:   $f ($lines lines)"
            fi
          done < <(find knowledge -name "*.md")

          if [ "$failed" -ne 0 ]; then
            exit 1
          fi

      - name: Check knowledge base total line limit (max 5000)
        run: |
          total=$(find knowledge -name "*.md" -exec cat {} + | wc -l)
          echo "Total knowledge base lines: $total"
          if [ "$total" -gt 5000 ]; then
            echo "FAIL: total knowledge base is $total lines (max 5000)"
            exit 1
          fi
          echo "OK: total knowledge base is within limit."

      - name: Check commands, skills, and agents file line limits (per-file max 500)
        run: |
          failed=0
          while IFS= read -r f; do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 500 ]; then
              echo "FAIL: $f has $lines lines (max 500)"
              failed=1
            else
              echo "OK:   $f ($lines lines)"
            fi
          done < <(find commands skills agents -name "*.md")

          if [ "$failed" -ne 0 ]; then
            exit 1
          fi
